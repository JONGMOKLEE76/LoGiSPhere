<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LoGi-SPhere</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .header .nav-link:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .main-container {
            display: flex;
            min-height: calc(100vh - 120px);
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            border-bottom: 1px solid #34495e;
        }
        .sidebar-menu a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 20px;
            transition: background-color 0.3s;
            font-size: 16px;
            padding-left: 35px;
        }
        .sidebar-menu a:hover {
            background-color: #34495e;
        }
        .sidebar-menu a.active {
            background-color: #3498db;
            border-left: 4px solid #fff;
        }
        .container {
            flex: 1;
            padding: 40px;
            background-color: white;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Dashboard specific styles */
        .pivot-table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .pivot-table th, .pivot-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: center;
        }

        .pivot-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pivot-table th.week-header {
            background-color: #e3f2fd;
            min-width: 120px;
            font-size: 12px;
        }

        .pivot-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-cell {
            cursor: pointer;
            padding: 12px 8px;
            font-weight: bold;
            transition: all 0.2s;
            min-height: 40px;
        }

        .data-cell:hover {
            background-color: #e0e0e0 !important;
            transform: scale(1.02);
        }

        /* PO/SP ÎπÑÏú®Ïóê Îî∞Î•∏ ÏÉâÏÉÅ */
        .ratio-excellent { background-color: #d4edda !important; color: #155724; } /* 100% Ïù¥ÏÉÅ */
        .ratio-good { background-color: #fff3cd !important; color: #856404; }      /* 50-99% */
        .ratio-critical { background-color: #f5c6cb !important; color: #680202; }  /* 50% ÎØ∏Îßå */
        .ratio-none { background-color: #e2e3e5 !important; color: #6c757d; }      /* PO ÏóÜÏùå */

        .total-row {
            background-color: #e9ecef !important;
            font-weight: bold;
        }

        .total-cell {
            font-weight: bold;
            color: #333;
        }

        /* ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏòÅÏó≠ */
        .details-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 3px solid #3498db;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .details-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .details-table th, .details-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .details-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .sp-details .details-table th {
            background-color: #d4edda;
        }

        .po-details .details-table th {
            background-color: #f8d7da;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 5px;
        }

        /* POÍ∞Ä SPÎ•º Ï¥àÍ≥ºÌïòÎäî ÏºÄÏù¥Ïä§Ïö© Ïä§ÌÉÄÏùº */
        .po-only-case {
            background-color: #ffe0b2 !important;
            border: 2px solid #ff9800 !important;
            animation: attention-pulse 2s infinite;
        }

        .po-only-text {
            font-weight: bold;
            font-style: italic;
            color: #e65100;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            font-size: 16px;
        }

        @keyframes attention-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Search filter styles */
        .search-filter {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .reset-btn:hover {
            background: #5a6268;
        }

        .sp-section .section-title {
            background-color: #d4edda;
            color: #155724;
        }

        .po-section .section-title {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
    <h1>üìä Dashboard</h1>
    {% if user_info %}
    <div style="display:flex; align-items:center; gap:12px;">
        <img src="/static/avatars/{{ user_info.avatar }}" alt="avatar" style="width:32px; height:32px; border-radius:50%; box-shadow:0 2px 8px #764ba2;">
        <span style="font-size:1em; font-weight:bold; color:#fff;">Hi! {{ user_info.username }}</span>
        <a href="/logout" style="background:#dc3545; color:white; padding:5px 14px; border-radius:6px; text-decoration:none; font-weight:bold; margin-left:8px;">Logout</a>
    </div>
    {% endif %}
    </div>
    <div class="main-container">
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/" id="home-link">üè† Home</a></li>
                <li><a href="/dashboard" id="dashboard-link" class="active">üìä Dashboard</a></li>
                <li><a href="/shipment" id="shipment-link">üì¶ Shipment</a></li>
                <li><a href="/po" id="po-link">üìã Purchase Orders</a></li>
                <li><a href="/booking" id="booking-link">üìñ Booking</a></li>
                {% if user_info and user_info.is_admin == 1 %}
                <li><a href="/users" id="users-link">üë§ User Management</a></li>
                {% endif %}
            </ul>
        </nav>
        <div class="container">
        <!-- Search Filter Form -->
        <div class="search-filter">
            <form method="GET" action="{{ url_for('dashboard') }}">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="supplier">Supplier:</label>
                        <select name="supplier" id="supplier">
                            {% for supplier in suppliers %}
                                {% if supplier == 'All' %}
                                    <option value="" {% if request.args.get('supplier', '') == '' %}selected{% endif %}>All</option>
                                {% else %}
                                    <option value="{{ supplier }}" {% if request.args.get('supplier') == supplier %}selected{% endif %}>{{ supplier }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
               <label for="week_from">Week From:</label>
               <input type="text" name="week_from" id="week_from" 
                   placeholder="YYYY-MM-DD(W00)" 
                   value="{{ week_from or default_weekname }}">
                    </div>
                    
                    <div class="filter-group">
               <label for="week_to">Week To:</label>
               <input type="text" name="week_to" id="week_to" 
                   placeholder="YYYY-MM-DD(W00)" 
                   value="{{ week_to or default_weekname_to }}">
                    </div>
                    
                    <button type="submit" class="search-btn">Search</button>
                    <a href="{{ url_for('dashboard') }}" class="reset-btn" style="text-decoration: none; display: inline-block; text-align: center;">Reset</a>
                </div>
            </form>
        </div>

        {% if search_executed %}
        <h2>Shipment vs PO Analysis</h2>
        <p style="margin-bottom: 20px; color: #666;">Click on any cell to view detailed records</p>
        
        <!-- ÎπÑÏú® ÏÉâÏÉÅ Î≤îÎ°Ä -->
        <div class="ratio-legend" style="margin-bottom: 18px; display: flex; gap: 18px; align-items: center;">
            <span style="display: flex; align-items: center;"><span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#d4edda;border:1px solid #b7dfb7;margin-right:6px;"></span>100% (Sufficient)</span>
            <span style="display: flex; align-items: center;"><span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#fff3cd;border:1px solid #ffe69c;margin-right:6px;"></span>50~99% (Warning)</span>
            <span style="display: flex; align-items: center;"><span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#f5c6cb;border:1px solid #f1b0b7;margin-right:6px;"></span>Below 50% (Insufficient)</span>
            <span style="display: flex; align-items: center;"><span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#e2e3e5;border:1px solid #cfd2d6;margin-right:6px;"></span>No Shipment Plan</span>
            <span style="display: flex; align-items: center;"><span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#ffe0b2;border:2px solid #ff9800;margin-right:6px;"></span>PO exceeds Shipment Plan</span>
        </div>
        
        {% if pivot_data %}
        <table class="pivot-table">
            <thead>
                <tr>
                    <th style="background-color: #2c3e50; color: white;">To Site</th>
                    {% for week in weeks %}
                    <th class="week-header">{{ week }}</th>
                    {% endfor %}
                    <th class="week-header" style="background-color: #3498db; color: white;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for to_site, weeks_data in pivot_data.items() %}
                <tr>
                    <td style="background-color: #ecf0f1; font-weight: bold; text-align: left; padding-left: 15px;">{{ to_site }}</td>
                    {% for week in weeks %}
                    {% set week_data = weeks_data.get(week, {}) %}
                    {% set po_qty = week_data.get('po', 0) %}
                    {% set sp_qty = week_data.get('sp', 0) %}
                    {% set ratio = (po_qty / sp_qty * 100) if sp_qty > 0 else 0 %}
                    <td class="data-cell 
                                {% if po_qty > sp_qty %}po-only-case
                                {% elif sp_qty == 0 %}ratio-none
                                {% elif ratio >= 100 %}ratio-excellent
                                {% elif ratio >= 50 %}ratio-good
                                {% else %}ratio-critical{% endif %}"
                        onclick="showDetails('{{ to_site }}', '{{ week }}', this)">
                        {% if sp_qty > 0 %}
                            <div style="font-size: 16px; font-weight: bold;">{{ po_qty }}/{{ sp_qty }}</div>
                        {% elif po_qty > 0 %}
                            <div class="po-only-text">{{ po_qty }}/0</div>
                        {% else %}
                            <div style="color: #6c757d;">-</div>
                        {% endif %}
                    </td>
                    {% endfor %}
                    {% set total_po = week_totals.get(to_site, {}).get('po', 0) %}
                    {% set total_sp = week_totals.get(to_site, {}).get('sp', 0) %}
                    {% set total_ratio = (total_po / total_sp * 100) if total_sp > 0 else 0 %}
                    <td class="total-cell 
                              {% if total_sp == 0 and total_po > 0 %}po-only-case
                              {% elif total_sp == 0 %}ratio-none
                              {% elif total_ratio >= 100 %}ratio-excellent
                              {% elif total_ratio >= 50 %}ratio-good
                              {% else %}ratio-critical{% endif %}">
                        <div style="font-size: 14px;" 
                             {% if total_sp == 0 and total_po > 0 %}class="po-only-text"{% endif %}>
                            {{ total_po }}/{{ total_sp if total_sp > 0 else '0' }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                <!-- Grand Total Row -->
                <tr class="total-row">
                    <td style="background-color: #3498db; color: white; font-weight: bold; text-align: left; padding-left: 15px;">Grand Total</td>
                    {% for week in weeks %}
                    {% set week_po = grand_totals.get(week, {}).get('po', 0) %}
                    {% set week_sp = grand_totals.get(week, {}).get('sp', 0) %}
                    {% set week_ratio = (week_po / week_sp * 100) if week_sp > 0 else 0 %}
                    <td class="total-cell 
                              {% if week_sp == 0 and week_po > 0 %}po-only-case
                              {% elif week_sp == 0 %}ratio-none
                              {% elif week_ratio >= 100 %}ratio-excellent
                              {% elif week_ratio >= 50 %}ratio-good
                              {% else %}ratio-critical{% endif %}">
                        <div style="font-size: 13px;" 
                             {% if week_sp == 0 and week_po > 0 %}class="po-only-text"{% endif %}>
                            {{ week_po }}/{{ week_sp if week_sp > 0 else '0' }}
                        </div>
                    </td>
                    {% endfor %}
                    {% set overall_po = overall_total.get('po', 0) %}
                    {% set overall_sp = overall_total.get('sp', 0) %}
                    {% set overall_ratio = (overall_po / overall_sp * 100) if overall_sp > 0 else 0 %}
                    <td class="total-cell 
                              {% if overall_sp == 0 and overall_po > 0 %}po-only-case
                              {% elif overall_sp == 0 %}ratio-none
                              {% elif overall_ratio >= 100 %}ratio-excellent
                              {% elif overall_ratio >= 50 %}ratio-good
                              {% else %}ratio-critical{% endif %}">
                        <div style="font-size: 14px; font-weight: bold;" 
                             {% if overall_sp == 0 and overall_po > 0 %}class="po-only-text"{% endif %}>
                            {{ overall_po }}/{{ overall_sp if overall_sp > 0 else '0' }}
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÌëúÏãú ÏòÅÏó≠ -->
        <div id="details-section" class="details-section" style="display: none;">
            <div class="details-header" id="details-title"></div>
            
            <div id="sp-details" class="sp-section">
                <div class="section-title">üì¶ Shipment Plans</div>
                <table class="details-table" id="sp-table">
                    <thead>
                        <tr>
                            <th>From Site</th>
                            <th>Model</th>
                            <th>Quantity</th>
                            <th>Original Week</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="sp-tbody"></tbody>
                </table>
            </div>

            <div id="po-details" class="po-section">
                <div class="section-title">üìã Purchase Orders</div>
                <table class="details-table" id="po-table">
                    <thead>
                        <tr>
                            <th>PO Number</th>
                            <th>From Site</th>
                            <th>Model</th>
                            <th>Quantity</th>
                            <th>Original Week</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody id="po-tbody"></tbody>
                </table>
            </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 50px; background: white; border-radius: 10px; margin-top: 30px;">
                <h3>No data available for the selected criteria.</h3>
                <p>Try adjusting your search filters or add some data.</p>
            </div>
            {% endif %}
        {% else %}
        <div style="text-align: center; padding: 80px; background: white; border-radius: 10px; margin-top: 30px;">
            <h3>üìä Welcome to Dashboard</h3>
            <p style="color: #666; font-size: 16px; margin-bottom: 20px;">Please select search criteria above to view the Shipment vs PO Analysis.</p>
            <div style="color: #888; font-size: 14px;">
                <p>üí° You can filter by:</p>
                <ul style="text-align: left; display: inline-block; margin: 0;">
                    <li>Supplier (From Site)</li>
                    <li>Week range (From/To dates)</li>
                    <li>Or leave all filters empty to see all data</li>
                </ul>
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    {% if search_executed and pivot_data %}
    <script>
        // ÌîºÎ≤ó Îç∞Ïù¥ÌÑ∞Î•º JavaScript Î≥ÄÏàòÎ°ú Ï†ÑÎã¨
        const pivotData = {{ pivot_data | tojson }};
        console.log('Pivot Data loaded:', pivotData);

        function showDetails(toSite, week, element) {
            console.log('showDetails called with:', {toSite, week});
            
            // Get details from JavaScript variable instead of HTML attribute
            const siteData = pivotData[toSite];
            if (!siteData) {
                console.log('No site data found for:', toSite);
                showEmptyDetails(toSite, week);
                return;
            }
            
            const weekData = siteData[week];
            if (!weekData) {
                console.log('No week data found for:', week);
                showEmptyDetails(toSite, week);
                return;
            }
            
            const details = weekData.details || {sp: [], po: []};
            console.log('Details found:', details);
            
            const detailsSection = document.getElementById('details-section');
            const detailsTitle = document.getElementById('details-title');
            const spTbody = document.getElementById('sp-tbody');
            const poTbody = document.getElementById('po-tbody');
            
            // Ï†úÎ™© ÏÑ§Ï†ï
            detailsTitle.textContent = `${toSite} - ${week} Details`;
            
            // SP Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            spTbody.innerHTML = '';
            if (details.sp && details.sp.length > 0) {
                details.sp.forEach(record => {
                    const row = document.createElement('tr');
                    const originalWeek = record.original_shipping_week || week;
                    const isCarryOver = originalWeek !== week;
                    
                    row.innerHTML = `
                        <td>${record.from_site || 'N/A'}</td>
                        <td>${record.model_name || 'N/A'}</td>
                        <td style="text-align: right; font-weight: bold;">${record.quantity || 0}</td>
                        <td style="${isCarryOver ? 'color: #ff6b00; font-weight: bold;' : ''}">${originalWeek}</td>
                        <td>${record.remark || ''}</td>
                    `;
                    spTbody.appendChild(row);
                });
            } else {
                spTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No Shipment Plans</td></tr>';
            }
            
            // PO Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            poTbody.innerHTML = '';
            if (details.po && details.po.length > 0) {
                details.po.forEach(record => {
                    const row = document.createElement('tr');
                    const originalWeek = record.original_week || 'N/A';
                    const isCarryOver = originalWeek !== week;
                    
                    row.innerHTML = `
                        <td>${record.po_number || 'N/A'}</td>
                        <td>${record.from_site || 'N/A'}</td>
                        <td>${record.model || 'N/A'}</td>
                        <td style="text-align: right; font-weight: bold;">${record.quantity || 0}</td>
                        <td style="${isCarryOver ? 'color: #ff6b00; font-weight: bold;' : ''}">${originalWeek}</td>
                        <td>${record.remark || ''}</td>
                    `;
                    poTbody.appendChild(row);
                });
            } else {
                poTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No Purchase Orders</td></tr>';
            }
            
            // ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏòÅÏó≠ ÌëúÏãú
            detailsSection.style.display = 'block';
            detailsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showEmptyDetails(toSite, week) {
            const detailsSection = document.getElementById('details-section');
            const detailsTitle = document.getElementById('details-title');
            const spTbody = document.getElementById('sp-tbody');
            const poTbody = document.getElementById('po-tbody');
            
            // Ï†úÎ™© ÏÑ§Ï†ï
            detailsTitle.textContent = `${toSite} - ${week} Details`;
            
            // Îπà Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            spTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No Shipment Plans</td></tr>';
            poTbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No Purchase Orders</td></tr>';
            
            // ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏòÅÏó≠ ÌëúÏãú
            detailsSection.style.display = 'block';
            detailsSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
    {% endif %}
</body>
</html>